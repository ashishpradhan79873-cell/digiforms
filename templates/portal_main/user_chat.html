{% extends 'base.html' %}

{% block title %}Chat With Admin{% endblock %}
{% block body_class %}min-h-screen bg-slate-100 text-slate-900{% endblock %}
{% block page_container_class %}max-w-5xl mx-auto p-4 md:p-6{% endblock %}
{% block page_header %}{% endblock %}

{% block content %}
<style>
  .card { background:#fff; border:1px solid #d7dde7; border-radius:14px; }
  .bubble { border-radius:12px; padding:10px 12px; max-width:80%; border:1px solid #dbe3ef; }
  .bubble-user { background:#eff6ff; border-color:#bfdbfe; margin-left:auto; }
  .bubble-admin { background:#f8fafc; }
  .att-image { margin-top:8px; width:240px; max-width:100%; border-radius:10px; border:1px solid #dbe3ef; display:block; }
  .att-box { margin-top:8px; border:1px solid #dbe3ef; background:#f8fafc; border-radius:10px; padding:8px 10px; }
  .msg-line { font-size:12px; color:#64748b; margin-top:4px; }
</style>

<header class="card p-4 flex flex-wrap items-center justify-between gap-3">
  <div>
    <h1 class="text-2xl font-black">Chat With Admin</h1>
    <p class="text-sm text-slate-600">Applicant ID: #{{ profile.id }}</p>
  </div>
  <a href="{% url 'role_select' %}" class="rounded-lg bg-slate-900 px-3 py-2 text-sm font-bold text-white">Back</a>
</header>

{% if messages %}
  <div class="mt-4 space-y-2">
    {% for message in messages %}
      <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm font-semibold text-emerald-700">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<section class="card mt-4 p-4">
  <div class="flex items-center justify-between gap-2">
    <h2 class="text-lg font-black">Conversation</h2>
    <span class="rounded-full px-3 py-1 text-xs font-bold {% if chat_enabled %}bg-emerald-100 text-emerald-700{% else %}bg-amber-100 text-amber-700{% endif %}">
      {% if chat_enabled %}Chat Enabled{% else %}Waiting For Admin{% endif %}
    </span>
  </div>

  <div class="mt-4 space-y-3">
    {% for msg in chat_messages %}
      <div class="bubble {% if msg.from_admin %}bubble-admin{% else %}bubble-user{% endif %}">
        <div class="font-semibold text-sm">{% if msg.from_admin %}Admin{% else %}You{% endif %}</div>
        {% if msg.message %}
          <div class="mt-1 text-sm">{{ msg.message|linebreaksbr }}</div>
        {% endif %}
        {% if msg.attachment %}
          <div class="mt-2">
            {% if msg.attachment_kind == "image" %}
              <a href="{{ msg.attachment.url }}" target="_blank">
                <img src="{{ msg.attachment.url }}" alt="{{ msg.attachment_name }}" class="att-image">
              </a>
            {% elif msg.attachment_kind == "pdf" %}
              <div class="att-box">
                <div class="text-xs font-semibold text-slate-600">PDF</div>
                <div class="text-sm font-bold text-slate-900">{{ msg.attachment_name }}</div>
              </div>
            {% else %}
              <div class="att-box">
                <div class="text-xs font-semibold text-slate-600">Attachment</div>
                <div class="text-sm font-bold text-slate-900">{{ msg.attachment_name }}</div>
              </div>
            {% endif %}
            <a href="{{ msg.attachment.url }}" target="_blank" download class="mt-2 inline-block text-sm font-bold text-blue-700 underline">Download</a>
            <a href="{{ msg.attachment.url }}" target="_blank" class="ml-3 inline-block text-sm font-bold text-emerald-700 underline">Open</a>
          </div>
        {% endif %}
        {% if msg.attachment and msg.attachment_kind == "pdf" %}
          <div class="mt-2">
            <a href="{{ msg.attachment.url }}" target="_blank" class="text-xs text-slate-500">PDF preview browser me open hoga</a>
          </div>
        {% endif %}
        <div class="msg-line">{{ msg.created_at|date:"Y-m-d H:i" }}</div>
      </div>
    {% empty %}
      <div class="text-sm text-slate-500">No messages yet.</div>
    {% endfor %}
  </div>
</section>

<section class="card mt-4 p-4">
  <h2 class="text-lg font-black">Send Message</h2>
  <form method="post" enctype="multipart/form-data" class="mt-3 grid gap-3">
    {% csrf_token %}
    <textarea name="message" rows="4" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm" placeholder="Type your message"></textarea>
    <input type="file" name="attachment" accept=".jpg,.jpeg,.png,.pdf,.webp,.gif" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
    <button type="submit" class="rounded-lg bg-emerald-700 px-4 py-2 text-sm font-bold text-white disabled:opacity-50" {% if not chat_enabled %}disabled{% endif %}>Send</button>
  </form>
</section>
{% endblock %}
